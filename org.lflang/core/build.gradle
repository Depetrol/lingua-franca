plugins {
  id 'org.jetbrains.kotlin.jvm' version "${kotlinVersion}"
  id 'java-library'
}

sourceSets {
  main {
    java {
       srcDirs = ['src/main/java', 'src-gen']
    }
    resources {
       srcDirs = ['src/main/resources', 'src-gen']
    }
  }
}

compileKotlin {
    kotlinOptions {
        jvmTarget = kotlinJvmTarget
    }
}
compileTestKotlin {
    kotlinOptions {
        jvmTarget = kotlinJvmTarget
    }
}

repositories {
    mavenCentral()
    // TODO Replace this unofficial maven repository as soon as Klighd is released to maven central in the future.
    maven {
        url "https://rtsys.informatik.uni-kiel.de/~kieler/files/repo/"
    }
}

dependencies {
    api "org.eclipse.xtext:org.eclipse.xtext:$xtextVersion"
    api "org.eclipse.xtext:org.eclipse.xtext.xbase.lib:$xtextVersion"
    api "org.eclipse.xtext:org.eclipse.xtext.ide:$xtextVersion"

    implementation "org.eclipse.emf:org.eclipse.emf.mwe2.launch:$mwe2LaunchVersion"

    implementation "com.fasterxml.jackson.core:jackson-core:$fasterxmlVersion"
    implementation "com.fasterxml.jackson.core:jackson-annotations:$fasterxmlVersion"
    implementation "com.fasterxml.jackson.core:jackson-databind:$fasterxmlVersion"

    implementation ("de.cau.cs.kieler.klighd:de.cau.cs.kieler.klighd.lsp:$klighdVersion") {
        exclude group: 'org.eclipse.platform', module: 'org.eclipse.swt.*'
        exclude group: 'org.eclipse.platform', module: 'org.eclipse.swt'
    }
    implementation ("de.cau.cs.kieler.klighd:de.cau.cs.kieler.klighd.standalone:$klighdVersion") {
        exclude group: 'org.eclipse.platform', module: 'org.eclipse.swt.*'
        exclude group: 'org.eclipse.platform', module: 'org.eclipse.swt'
    }
}

configurations {
    mwe2 {
        extendsFrom implementation
    }
}

dependencies {
    mwe2 'org.eclipse.emf:org.eclipse.emf.mwe2.launch'
    mwe2 "org.eclipse.xtext:org.eclipse.xtext.common.types:${xtextVersion}"
    mwe2 "org.eclipse.xtext:org.eclipse.xtext.xtext.generator:${xtextVersion}"
}

tasks.register('generateXtextLanguage', JavaExec) {
    main = 'org.eclipse.emf.mwe2.launch.runtime.Mwe2Launcher'
    classpath = configurations.mwe2
    inputs.file "src/main/java/org/lflang/GenerateLinguaFranca.mwe2"
    inputs.file "src/main/java/org/lflang/LinguaFranca.xtext"
    outputs.dir "src-gen"
    outputs.dir "model"
    outputs.file ".antlr-generator-3.2.0-patch.jar"
    args += "src/main/java/org/lflang/GenerateLinguaFranca.mwe2"
    args += "-p"
    args += "rootPath=/${projectDir}/.."
}

compileJava.dependsOn(generateXtextLanguage)
compileKotlin.dependsOn(generateXtextLanguage)
processResources.dependsOn(generateXtextLanguage)
clean.dependsOn(cleanGenerateXtextLanguage)